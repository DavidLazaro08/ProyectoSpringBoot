<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - Proyecto SaaS</title>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>

<body>

    <div class="contenedor contenedor-lg">
        <!-- Header con usuario autenticado -->
        <div class="cabecera-dashboard">
            <div class="info-usuario">
                <div class="avatar-usuario" th:text="${usuario.email.substring(0,1).toUpperCase()}">U</div>
                <div>
                    <div class="nombre-usuario"
                        th:text="${usuario.perfil != null ? usuario.perfil.nombre + ' ' + usuario.perfil.apellidos : usuario.email}">
                        Usuario
                    </div>
                    <div class="email-usuario" th:text="${email}">email@example.com</div>
                </div>
            </div>
            <form method="post" action="/logout" class="form-logout">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="boton-cerrar-sesion">Cerrar Sesi√≥n</button>
            </form>
        </div>

        <div class="barra-titulo">
            <h1>Mi Perfil</h1>
            <a th:href="@{/}" class="enlace-volver">‚Üê Volver al Inicio</a>
        </div>

        <!-- Mensajes Flash -->
        <div th:if="${mensaje}" th:class="'mensaje ' + ${tipoMensaje != null ? tipoMensaje : 'exito'}"
            th:text="${mensaje}">
        </div>

        <div class="grid-dashboard">
            <!-- Tarjeta Usuario y Plan -->
            <div class="tarjeta">
                <h3>Suscripci√≥n</h3>
                <div class="etiqueta-stat">Usuario</div>
                <div class="valor-stat"
                    th:text="${usuario.perfil != null ? usuario.perfil.nombre + ' ' + usuario.perfil.apellidos : usuario.email}">
                    Usuario</div>

                <div class="etiqueta-stat">Plan Actual</div>
                <div class="valor-stat valor-stat-plan" th:text="${suscripcion.plan.nombre}">Plan</div>

                <div class="etiqueta-stat">Estado</div>
                <div class="valor-stat">
                    <span th:text="${suscripcion.estado}"
                        th:class="${suscripcion.estado.name() == 'ACTIVA' ? 'estado-activo' : 'estado-inactivo'}">
                    </span>
                </div>

                <div class="etiqueta-stat">Pr√≥xima Renovaci√≥n</div>
                <div class="valor-stat" th:text="${#temporals.format(suscripcion.fechaFinCiclo, 'dd/MM/yyyy HH:mm')}">
                    Fecha</div>

                <form action="/facturas/renovar" method="post" class="form-renovar">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="email" th:value="${email}">
                    <button type="submit" class="boton boton-ancho-completo">Renovar Ahora</button>
                </form>
            </div>

            <!-- Tarjeta Facturaci√≥n -->
            <div class="tarjeta">
                <h3>Facturaci√≥n</h3>
                <div th:if="${ultimaFactura != null}">
                    <div class="etiqueta-stat">√öltima Factura</div>
                    <div class="valor-stat" th:text="${#temporals.format(ultimaFactura.fecha, 'dd/MM/yyyy')}">Fecha
                    </div>
                    <div class="valor-stat" th:text="${ultimaFactura.total + ' ‚Ç¨'}">Total</div>

                    <div class="contenedor-badge">
                        <span th:if="${ultimaFacturaPagada}" class="badge-pagada">‚úî PAGADA</span>
                        <span th:unless="${ultimaFacturaPagada}" class="badge-pendiente">‚ö† PENDIENTE DE PAGO</span>
                    </div>
                </div>
                <div th:if="${ultimaFactura == null}">
                    <p>No hay facturas registradas.</p>
                </div>

                <a th:href="@{/mis-facturas}" class="boton-outline">Ver Mis Facturas</a>
            </div>

            <!-- Tarjeta M√©todo de Pago -->
            <div class="tarjeta">
                <h3>üí≥ M√©todo de Pago</h3>
                <p class="subtitulo-pago">Selecciona tu m√©todo de pago preferido</p>

                <form th:action="@{/dashboard/pago}" method="post" id="pagoForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Tarjeta -->
                    <div class="opcion-pago">
                        <label>
                            <span class="opcion-pago-contenido">
                                <span class="icono-pago">üí≥</span>
                                <span class="nombre-metodo">Tarjeta de Cr√©dito</span>
                                <span th:if="${metodoPagoPreferido == 'Tarjeta'}" class="check-metodo">‚úì</span>
                            </span>
                            <input type="radio" name="tipoPago" value="Tarjeta"
                                th:checked="${metodoPagoPreferido == 'Tarjeta' or metodoPagoPreferido == null}"
                                onchange="mostrarCamposPago('tarjeta')">
                        </label>
                    </div>
                    <div id="campos-tarjeta" class="campos-pago">
                        <div class="grupo-campo-pago">
                            <label class="campo-label">√öltimos 4 d√≠gitos:</label>
                            <input type="text" name="ultimos4" id="ultimos4" placeholder="4567" maxlength="4"
                                pattern="\d{4}" class="campo-input-corto">
                        </div>
                        <div>
                            <label class="campo-label">Titular:</label>
                            <input type="text" name="titular" id="titular" placeholder="Nombre del titular"
                                class="campo-input">
                        </div>
                    </div>

                    <!-- PayPal -->
                    <div class="opcion-pago">
                        <label>
                            <span class="opcion-pago-contenido">
                                <span class="icono-pago">üÖøÔ∏è</span>
                                <span class="nombre-metodo">PayPal</span>
                                <span th:if="${metodoPagoPreferido == 'PayPal'}" class="check-metodo">‚úì</span>
                            </span>
                            <input type="radio" name="tipoPago" value="PayPal"
                                th:checked="${metodoPagoPreferido == 'PayPal'}" onchange="mostrarCamposPago('paypal')">
                        </label>
                    </div>
                    <div id="campos-paypal" class="campos-pago">
                        <div>
                            <label class="campo-label">Email PayPal:</label>
                            <input type="email" name="emailPaypal" id="emailPaypal" placeholder="tu@email.com"
                                class="campo-input">
                        </div>
                    </div>

                    <!-- Transferencia Bancaria -->
                    <div class="opcion-pago">
                        <label>
                            <span class="opcion-pago-contenido">
                                <span class="icono-pago">üè¶</span>
                                <span class="nombre-metodo">Transferencia Bancaria</span>
                                <span th:if="${metodoPagoPreferido == 'Transferencia'}" class="check-metodo">‚úì</span>
                            </span>
                            <input type="radio" name="tipoPago" value="Transferencia"
                                th:checked="${metodoPagoPreferido == 'Transferencia'}"
                                onchange="mostrarCamposPago('transferencia')">
                        </label>
                    </div>
                    <div id="campos-transferencia" class="campos-pago">
                        <div class="grupo-campo-pago">
                            <label class="campo-label">IBAN:</label>
                            <input type="text" name="iban" id="iban" placeholder="ES91 2100 0418 4502 0005 1332"
                                class="campo-input">
                        </div>
                        <div>
                            <label class="campo-label">Referencia (opcional):</label>
                            <input type="text" name="referencia" id="referencia"
                                placeholder="Se generar√° autom√°ticamente" class="campo-input">
                        </div>
                    </div>

                    <button type="submit" class="boton-registrar-pago">Registrar Pago</button>
                    <small class="aviso-demo">
                        * Sistema de demostraci√≥n - No se procesar√°n pagos reales
                    </small>
                </form>

                <script>
                    function mostrarCamposPago(tipo) {
                        // Ocultar todos los campos
                        document.getElementById('campos-tarjeta').style.display = 'none';
                        document.getElementById('campos-paypal').style.display = 'none';
                        document.getElementById('campos-transferencia').style.display = 'none';

                        // Mostrar solo el seleccionado
                        if (tipo === 'tarjeta') {
                            document.getElementById('campos-tarjeta').style.display = 'block';
                        } else if (tipo === 'paypal') {
                            document.getElementById('campos-paypal').style.display = 'block';
                        } else if (tipo === 'transferencia') {
                            document.getElementById('campos-transferencia').style.display = 'block';
                        }

                        // Actualizar indicadores visuales (bordes)
                        const opciones = document.querySelectorAll('.opcion-pago');
                        opciones.forEach(opcion => {
                            opcion.style.border = '1px solid #e0e0e0';
                            opcion.style.background = 'white';
                        });

                        // Resaltar la opci√≥n seleccionada
                        const radioSeleccionado = document.querySelector('input[name="tipoPago"]:checked');
                        if (radioSeleccionado) {
                            const opcionSeleccionada = radioSeleccionado.closest('.opcion-pago');
                            opcionSeleccionada.style.border = '1px solid #007bff';
                            opcionSeleccionada.style.background = '#f0f8ff';
                        }
                    }

                    // Ejecutar al cargar la p√°gina para mostrar el m√©todo preferido
                    document.addEventListener('DOMContentLoaded', function () {
                        const radioSeleccionado = document.querySelector('input[name="tipoPago"]:checked');
                        if (radioSeleccionado) {
                            const valor = radioSeleccionado.value.toLowerCase();
                            mostrarCamposPago(valor);
                        }
                    });

                    // Validaci√≥n del formulario
                    document.addEventListener('DOMContentLoaded', function () {
                        document.getElementById('pagoForm').addEventListener('submit', function (e) {
                            const tipoPago = document.querySelector('input[name="tipoPago"]:checked').value;

                            if (tipoPago === 'Tarjeta') {
                                const ultimos4 = document.getElementById('ultimos4').value;
                                const titular = document.getElementById('titular').value;
                                if (!ultimos4 || ultimos4.length !== 4 || !/^\d{4}$/.test(ultimos4)) {
                                    e.preventDefault();
                                    alert('Por favor, ingresa exactamente 4 d√≠gitos num√©ricos');
                                    return;
                                }
                                if (!titular || titular.trim().length < 3) {
                                    e.preventDefault();
                                    alert('El titular debe tener al menos 3 caracteres');
                                    return;
                                }
                            } else if (tipoPago === 'PayPal') {
                                const emailPaypal = document.getElementById('emailPaypal').value;
                                if (!emailPaypal || !emailPaypal.includes('@')) {
                                    e.preventDefault();
                                    alert('Ingresa un email v√°lido de PayPal');
                                    return;
                                }
                            } else if (tipoPago === 'Transferencia') {
                                const iban = document.getElementById('iban').value;
                                if (!iban || iban.replace(/\s/g, '').length < 20) {
                                    e.preventDefault();
                                    alert('Ingresa un IBAN v√°lido');
                                    return;
                                }
                            }
                        });
                    });
                </script>
            </div>

        </div> <!-- FIN grid-dashboard -->

        <!-- Secci√≥n Cambiar Plan (FUERA del grid) -->
        <div class="seccion-planes">
            <h3 class="titulo-planes">Cambiar Plan</h3>
            <p class="subtitulo-planes">
                Selecciona el plan que mejor se adapte a tus necesidades
            </p>

            <!-- CONTENEDOR FLEX -->
            <div class="grid-planes">

                <!-- Tarjetas de planes -->
                <div th:each="plan : ${planes}" class="tarjeta-plan"
                    th:classappend="${suscripcion.plan.id == plan.id} ? 'plan-actual' : ''">

                    <!-- Badge si es plan actual -->
                    <div th:if="${suscripcion.plan.id == plan.id}" class="badge-plan-actual">
                        Plan Actual
                    </div>

                    <!-- Nombre -->
                    <h4 th:text="${plan.nombre}" class="nombre-plan">PLAN</h4>

                    <!-- Precio -->
                    <div class="precio-plan-wrap">
                        <span th:text="${plan.precioMensual}" class="precio-plan">0.00</span>
                        <span class="unidad-precio">‚Ç¨/mes</span>
                    </div>

                    <!-- Bot√≥n -->
                    <form th:action="@{/dashboard/cambiar-plan}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="planId" th:value="${plan.id}" />
                        <button type="submit" th:disabled="${suscripcion.plan.id == plan.id}"
                            th:text="${suscripcion.plan.id == plan.id} ? 'Plan Actual' : 'Cambiar a ' + ${plan.nombre}"
                            th:classappend="${suscripcion.plan.id == plan.id} ? 'plan-activo' : ''"
                            class="boton-cambiar-plan">
                            Cambiar
                        </button>
                    </form>
                </div>

            </div>
        </div>

    </div>

</body>

</html>